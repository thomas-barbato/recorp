{% extends "generic_template.html" %}
{% load static %}
{% load customtags %}
{% load i18n %}

{% block content %}

<div class="flex flex-col min-h-screen bg-zinc-950 font-rajdhani">
    {% include "index-top-panel.html" %}
    
    <main class="flex-1 flex items-center justify-center w-full pt-24 pb-20 overflow-y-auto pt-24 pb-20">
        <form class="w-full max-w-7xl mx-auto" method="post" enctype="multipart/form-data">
            <!-- ÉTAPE 1 : Sélection de faction -->
            <div id="character-faction" class="flex flex-col gap-6">
                <!-- En-tête -->
                <div class="text-center space-y-2">
                    <h1 class="font-orbitron text-2xl sm:text-3xl md:text-4xl font-bold text-emerald-400 text-shadow-strong uppercase">
                        {% translate "Character creation" %}
                    </h1>
                    <p class="text-base sm:text-lg md:text-xl text-emerald-300/80 font-semibold">
                        {% translate "Select a faction" %}
                    </p>
                    <p class="text-xs sm:text-sm text-emerald-300/60 max-w-2xl mx-auto">
                        Votre faction déterminera vos alliés, vos ennemis et votre style de jeu. Choisissez avec sagesse.
                    </p>
                </div>

                <!-- Container des factions -->
                <div id="faction-container" class="grid grid-cols-1 md:grid-cols-3 gap-4 lg:gap-6">
                    {% for faction in factions %}
                        {% if faction.name != "none" %}
                        <div class="faction glow-card cursor-pointer border-2 border-emerald-500/30 bg-zinc-900/50 rounded-lg overflow-hidden transition-all" id="faction-{{ faction.id }}">
                            <!-- Header de la faction -->
                            <div class="bg-emerald-900/60 border-b border-emerald-500/40 p-3 text-center">
                                <h3 class="font-orbitron text-base sm:text-lg font-bold text-emerald-300 uppercase">
                                    {{ faction.name }}
                                </h3>
                            </div>
                            
                            <!-- Image placeholder -->
                            <div class="relative aspect-video bg-zinc-800/50 hidden md:block">
                                <img src="{% static '/img/ux/placeholder.svg' %}" class="w-full h-full object-cover opacity-60" alt="{{ faction.name }}">
                                <div class="absolute inset-0 bg-gradient-to-t from-zinc-900 to-transparent"></div>
                            </div>
                            
                            <!-- Description -->
                            <div class="p-4 space-y-3">
                                <p class="text-sm sm:text-base text-emerald-300/80 text-justify leading-relaxed line-clamp-4 md:line-clamp-6 lg:line-clamp-8">
                                    {{ faction.data.description }}
                                </p>
                                <a href="#" class="inline-block text-emerald-400 hover:text-emerald-300 text-sm font-semibold transition-colors">
                                    {% translate 'show more' %} →
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- Bouton suivant -->
                <div class="flex justify-center mt-4">
                    <button type="button" id="next-btn" disabled class="nav-button px-8 py-4 bg-emerald-500 hover:bg-emerald-400 text-zinc-950 font-bold font-orbitron rounded-lg text-base sm:text-lg transition-all disabled:opacity-30 disabled:cursor-not-allowed flex items-center gap-3 shadow-lg">
                        <span>SUIVANT</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- ÉTAPE 2 : Stats et informations du personnage -->
            <div id="character-stats" class="hidden flex-col gap-6">
                <!-- En-tête -->
                <div class="text-center space-y-2">
                    <h1 class="font-orbitron text-2xl sm:text-3xl md:text-4xl font-bold text-emerald-400 text-shadow-strong uppercase">
                        {% translate "Character creation" %}
                    </h1>
                    <p class="text-base sm:text-lg md:text-xl text-emerald-300/80 font-semibold">
                        Configurez votre personnage
                    </p>
                </div>

                <!-- Container principal -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Colonne gauche : Archétype et stats -->
                    <div class="space-y-6">
                        <!-- Sélection d'archétype -->
                        <div class="glow-card border border-emerald-500/30 bg-zinc-900/50 rounded-lg p-6">
                            <label for="id_archetype" class="block mb-3 text-sm sm:text-base md:text-lg font-bold text-emerald-300 font-orbitron uppercase">
                                {% translate "Select an archetype" %} <span class="text-red-500">*</span>
                            </label>
                            <select id="id_archetype" 
                                    class="w-full p-3 bg-zinc-800 border border-emerald-400 text-center rounded-lg text-emerald-300 font-semibold text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                <option selected disabled>--- Choisissez un archétype ---</option>
                                {% for archetype in archetype_data %}
                                <option value="{{ archetype.id }}">{% translate archetype.name %}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Informations d'archétype -->
                        <div id="archetype-informations">
                            {% for archetype in archetype_data %}
                            <div id="archetype-{{ archetype.id }}" class="hidden archetype-selector glow-card border border-emerald-500/30 bg-zinc-900/50 rounded-lg p-6 space-y-4">
                                <!-- Description -->
                                <div class="border-b border-emerald-500/20 pb-4">
                                    <p class="text-sm sm:text-base text-emerald-300/80 text-justify leading-relaxed">
                                        {% translate archetype.description %}
                                    </p>
                                </div>

                                <!-- Aperçu du vaisseau et stats -->
                                <div class="flex flex-col md:flex-row gap-4 items-start">
                                    <!-- Vaisseau -->
                                    <div class="flex justify-center items-center p-4 bg-zinc-800/50 rounded-lg border border-emerald-500/20">
                                        <img class="" src="{% static 'img/foreground/ships/illustration/'|add:archetype.ship_id__image|add:'.png' %}" alt="Vaisseau">
                                    </div>

                                    <!-- Points de compétences -->
                                    <div class="flex-1">
                                        <h4 class="font-orbitron text-sm sm:text-base md:text-lg font-bold text-emerald-300 mb-3 uppercase">
                                            {% translate "Starting skill points" %}
                                        </h4>
                                        <div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto thin-semi-transparent-scrollbar">
                                            {% for key, value in archetype.data.items %}
                                            <div class="flex items-center gap-2 bg-zinc-800/30 rounded p-2">
                                                <span class="iconify w-5 h-5 text-emerald-400
                                                {% if key == 'Thermal Weapon' %}game-icons--laser-blast
                                                {% elif key == 'Ballistic Weapon' %}game-icons--anti-aircraft-gun
                                                {% elif key == 'Missile Weapon' %}game-icons--missile-swarm
                                                {% elif key == 'Frigate' or key == 'Destroyer' or key == 'Battlecruiser' or key == 'Dreadnought' %}game-icons--interceptor-ship
                                                {% elif key == 'Termal Shield' %}game-icons--laser-warning
                                                {% elif key == 'Ballistic Shield' %}game-icons--shield-reflect
                                                {% elif key == 'Missile Shield' %}game-icons--dragon-shield
                                                {% elif key == 'Repaire' %}game-icons--auto-repair
                                                {% elif key == 'Shield Amelioration' %}game-icons--bolt-shield
                                                {% elif key == 'Evasive Maneuver' or key == 'Hide Signature' %}game-icons--invisible
                                                {% elif key == 'Detection' %}game-icons--aerial-signal
                                                {% elif key == 'Sharpshooting' %}game-icons--targeting
                                                {% elif key == 'Electronic Warfare' or key == 'Counter Electronic Warfare' %}game-icons--computing
                                                {% elif key == 'Research' %}game-icons--materials-science
                                                {% elif key == 'Crafting' %}game-icons--crafting
                                                {% elif key == 'Mining' %}game-icons--mining
                                                {% elif key == 'Refining' %}game-icons--melting-metal
                                                {% elif key == 'Planetary Exploitation' %}game-icons--wireframe-globe
                                                {% endif %}"></span>
                                                <span class="text-xs text-emerald-300/80 flex-1">{{ key }}</span>
                                                <span class="text-sm font-bold text-emerald-400">{{ value }}</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Modules de départ -->
                                <div class="border-t border-emerald-500/20 pt-4">
                                    <h4 class="font-orbitron text-sm sm:text-base md:text-lg font-bold text-emerald-300 mb-3 uppercase">
                                        {% translate "Starting modules" %}
                                    </h4>
                                    <div class="max-h-32 overflow-y-auto thin-semi-transparent-scrollbar space-y-1">
                                        {% for module in archetype_modules %}
                                            {% if archetype.id == module.archetype_id %}
                                            <div class="text-sm text-emerald-300/80 bg-zinc-800/30 rounded px-3 py-2">
                                                • {{ module.module_id__name }}
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Colonne droite : Informations du personnage -->
                    <div class="glow-card border border-emerald-500/30 bg-zinc-900/50 rounded-lg p-6 space-y-6">
                        <!-- Avatar -->
                        <div class="text-center space-y-3">
                            <label class="block text-sm sm:text-base md:text-lg font-bold text-emerald-300 font-orbitron uppercase">
                                {% translate 'Select your picture' %}
                            </label>
                            <div class="flex justify-center">
                                <div class="relative cursor-pointer group" onclick="document.getElementById('file').click()">
                                    <img class="w-32 h-32 rounded-lg border-2 border-emerald-500/40 group-hover:border-emerald-400 transition-all" id="user-avatar" src="{% static 'ux/default-user.svg' %}" alt="Avatar">
                                    <div class="absolute inset-0 bg-emerald-500/20 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                        <i class="fas fa-camera text-3xl text-emerald-300"></i>
                                    </div>
                                </div>
                            </div>
                            <input type="file" id="file" class="hidden" name="file" accept=".jpg, .png, .gif" />
                        </div>

                        <!-- Nom du personnage -->
                        <div>
                            <label for="id_name" class="block mb-3 text-sm sm:text-base md:text-lg font-bold text-emerald-300 font-orbitron uppercase">
                                {% translate "character name" %} <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="id_name" name="name" class="w-full p-3 bg-emerald-900/60 border border-emerald-500/40 rounded-lg text-emerald-300 placeholder-emerald-300/40 font-semibold text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Entrez le nom de votre personnage" required />
                        </div>

                        <!-- Description -->
                        <div>
                            <label for="editor" class="block mb-3 text-sm sm:text-base md:text-lg font-bold text-emerald-300 font-orbitron uppercase">
                                {% translate "Description" %}
                            </label>
                            <div id="editor" class="bg-zinc-800/50 border border-emerald-500/30 rounded-lg min-h-[200px] text-emerald-300">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Boutons de navigation -->
                <div class="flex justify-between items-center mt-6">
                    <button type="button" id="previous-btn"class="nav-button px-6 py-3 border-2 border-red-500/60 hover:border-red-400 text-red-400 hover:text-red-300 font-bold font-orbitron rounded-lg transition-all flex items-center gap-3 text-sm sm:text-base">
                        <i class="fas fa-arrow-left"></i>
                        <span>RETOUR</span>
                    </button>
                    <button type="button" id="create-character-submit-button" disabled class="nav-button px-8 py-3 bg-emerald-500 hover:bg-emerald-400 text-zinc-950 font-bold font-orbitron rounded-lg transition-all disabled:opacity-30 disabled:cursor-not-allowed shadow-lg text-base sm:text-lg">
                        VALIDER
                    </button>
                </div>
            </div>
        </form>
    </main>
    
    {% include "footer.html" %}
</div>

{% block js %}
<script>
    let archetype_id = undefined;
    let archetype_selector = document.querySelectorAll('.archetype-selector');

    // Gestion du changement d'archétype
    document.getElementById("id_archetype").addEventListener("change", function() {
        archetype_id = this.options[this.selectedIndex].getAttribute("value");
        
        archetype_selector.forEach(selector => {
            const selector_id = selector.id.split('-')[1];
            if(archetype_id != selector_id){
                selector.classList.add('hidden');
            } else {
                selector.classList.remove('hidden');
            }
        });
        
        checkFormValidity();
    });

    // Vérification de la validité du formulaire
    function checkFormValidity() {
        const nameInput = document.querySelector('#id_name');
        const archetypeSelect = document.querySelector('#id_archetype');
        const submitBtn = document.querySelector('#create-character-submit-button');
        
        const isNameValid = nameInput && nameInput.value.trim().length > 0;
        const isArchetypeValid = archetypeSelect && archetypeSelect.value !== "---" && archetype_id;
        
        if (isNameValid && isArchetypeValid) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    }

    // Écouter les changements du nom
    document.getElementById('id_name').addEventListener('input', checkFormValidity);
</script>

<script src="{% static 'js/quill/quill.js' %}" type="text/javascript"></script>
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet">
<script src="{% static 'js/quill/quill_element.js' %}" type="text/javascript"></script>

<script>
    let user_is_on_mobile_bool = is_user_is_on_mobile_device();
    let action_listener_touch_click = user_is_on_mobile_bool ? 'touchstart' : 'click';
    
    let faction_element = document.querySelectorAll('.faction');
    let faction_selected = "";

    let previous_button = document.querySelector("#previous-btn");
    let next_button = document.querySelector("#next-btn");

    let faction_window = document.querySelector("#character-faction");
    let stats_window = document.querySelector('#character-stats');

    const reader = new FileReader();
    const img_user = document.querySelector('#user-avatar');
    const img_input = document.querySelector('#file');

    let quill_content = undefined;

    // Configuration Quill
    const quill = new Quill('#editor', {
        modules: {
            toolbar: toolbarOptions
        },
        theme: 'snow'
    });

    quill.getHTML = () => {
        return quill.root.innerHTML;
    };

    quill.on('text-change', () => {
        quill_content = quill.getHTML();
    });

    // Style de l'éditeur Quill
    let toolbar = document.querySelector('.ql-editor');
    if (toolbar) {
        toolbar.classList.add('text-justify', 'min-h-[150px]', 'text-base', 'text-emerald-300');
    }

    // Navigation
    previous_button.addEventListener(action_listener_touch_click, function(){
        stats_window.classList.add('hidden');
        stats_window.classList.remove('flex');
        faction_window.classList.remove('hidden');
        faction_window.classList.add('flex');
    });

    
    next_button.addEventListener(action_listener_touch_click, function(e){
        e.preventDefault();
        e.stopPropagation();
        
        if (!this.disabled) {
            faction_window.classList.add('hidden');
            faction_window.classList.remove('flex');
            stats_window.classList.remove('hidden');
            stats_window.classList.add('flex');
        }
    });

    // Sélection de faction
    faction_element.forEach(faction => {
        faction.addEventListener(action_listener_touch_click, function(){
            // Désélectionner toutes les autres factions
            faction_element.forEach(f => {
                f.classList.remove('faction-selected');
            });
            
            // Sélectionner cette faction
            this.classList.add('faction-selected');
            faction_selected = this.id.split('-')[1];
            
            // Activer le bouton suivant
            next_button.disabled = false;
        });
    });

    // Gestion de l'image
    reader.onload = e => {
        img_user.src = e.target.result;
    };

    img_input.addEventListener('change', e => {
        const f = e.target.files[0];
        if (f) {
            reader.readAsDataURL(f);
            img_user.classList.add('border-emerald-500');
        }
    });

    // Soumission du formulaire
    let submit_btn = document.querySelector('#create-character-submit-button');

    submit_btn.addEventListener(action_listener_touch_click, function(){
        if (this.disabled) return;
        
        this.disabled = true;
        
        let archetype = document.querySelector('#id_archetype').value;
        let character_name = document.querySelector('#id_name').value;
        let description = quill_content || "";
        
        if (faction_selected && archetype && character_name) {
            let data = new FormData();
            const file = img_input.files[0];
            if (file) data.append('file', file);
            data.append('name', character_name);
            data.append('archetype', archetype);
            data.append('faction', faction_selected);
            data.append('description', description);

            const url = "create_character";
            const headers = new Headers({
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": csrf_token,
            });

            fetch(url, {
                method: "POST",
                headers,
                credentials: "include",
                body: data,
            })
            .then(async response => {
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    return response.json();
                } else {
                    window.location.replace("/");
                    return;
                }
            })
            .then(data => {
                if (!data) return;
                if (data.errors) {
                    console.error(data.errors);
                    submit_btn.disabled = false;
                }
            })
            .catch(error => {
                console.error("Erreur JS:", error);
                submit_btn.disabled = false;
            });
        }
    });
</script>
{% endblock %}
{% endblock %}